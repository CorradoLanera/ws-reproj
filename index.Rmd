---
title: "Efficient Reproducibility in R: A Journey from Patchworks to Projects"
subtitle: 'UBEP Seminars - LAIMS workshops'
author: "[CorradoLanera](www.CorradoLanera.it)"
date: "2023-05-16/18 (last update: `r Sys.Date()`)"
institute: "[Unit of Biostatistics, Epidemiology, and Public Health](https://www.unipd-ubep.it/) --- University of Padova"
output: 
  xaringan::moon_reader:
    seal: false  # no title slide! Do It Yourself here below
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
    css: xaringan-themer.css
---
class: center, middle, bg_title, hide-count


<img src="img/UniPD.png" width="150px"/>
<img src="img/DSCTV.png" width="50px"/>
<img src="img/UBEP.png" width="50px"/>
<img src="img/LAIMS.png" width="50px"/>

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  fig.retina = 3,
  warning = FALSE,
  message = FALSE,
  comment = "",
  out.width = "100%"
)
library(knitr)
library(xaringanExtra)
library(xaringanthemer)

library(tidyverse)
library(gridExtra)

library(countdown)
library(metathis)

options(width = 59) # fit into the right-column slides

```


```{r xaringans, echo=FALSE}
# https://github.com/gadenbuie/xaringanExtra
use_tachyons()
use_share_again()
use_panelset()
use_clipboard()
use_editable(expires = 1)
use_freezeframe()
use_extra_styles(
  hover_code_line = TRUE,         #<<
  mute_unhighlighted_code = TRUE  #<<
)
use_progress_bar(color = "#0051BA", location = "top")
```

```{r style-share-again, echo=FALSE}
style_share_again(
  share_buttons = c("twitter", "linkedin", "pocket")
)
```


```{r meta, echo=FALSE}
meta() %>%
  meta_general(
    description = "Efficient Reproducibility in R: A Journey from Patchworks to Projects",
    generator = "xaringan and remark.js"
  ) %>% 
  meta_name("github-repo" = "CorradoLanera/ws-reproj") %>% 
  meta_social(
    title = "Efficient Reproducibility in R: A Journey from Patchworks to Projects",
    url = "https://CorradoLanera.github.io/ws-reproj/#1",
    image = "https://github.com/CorradoLanera/ws-reproj/raw/main/img/cover.jpg",
    image_alt = "Photograph by @CorradoLanera",
    og_type = "website",
    og_author = "UBEP",
    twitter_card_type = "summary",
    twitter_creator = "@CorradoLanera"
  )
```

```{css, echo=FALSE}
.left-code {
  color: #777;
  width: 38%;
  height: 92%;
  float: left;
}
.right-code {
  color: #777;
  width: 55%;
  height: 92%;
  float: right;
  padding-top: 0.5em;
}
.left-plot {
  width: 43%;
  float: left;
}
.right-plot {
  width: 60%;
  float: right;
}
.hide-count .remark-slide-number {
  display: none;
}

.bg_title {
  position: relative;
  z-index: 1;
}

.bg_title::before {    
      content: "";
      background-image: url('img/bg1.png');
      background-size: contain;
      position: absolute;
      top: 0px;
      right: 0px;
      bottom: 0px;
      left: 0px;
      opacity: 0.3;
      z-index: -1;
}

```


```{r xaringan-themer, include=FALSE, warning=FALSE}
red <- "#f34213"
purple <- "#3e2f5b"
orange <- "#ff8811"
green <- "#136f63"
white <- "#FFFFFF"
pastel_orange <- "#F97B64"
blu_gray <- "#1F4257"
style_duo_accent(
    colors = c(
        red = red,
        purple = purple,
        orange = orange,
        green = green,
        white = white,
        pastel_orange = pastel_orange,
        blu_gray = blu_gray
    )
)
```


<br>
<br>
<br>

# **Efficient Reproducibility in R**<br>**.orange[A Journey from Patchworks to Projects]**

<br>
<br>

**LAIMS workshops** - Padova/UBEP + Teams, 2023/05/16-18

UBEP Seminars

Corrado Lanera | [**Unit of Biostatistics, Epidemiology, and Public Health**](https://www.unipd-ubep.it/)

---
class: inverse, bottom, right, hide-count


```{r, echo=FALSE, out.width = "50%"}
knitr::include_graphics("img/profilo_CL.jpg")
```
# Find me at...


[`r fontawesome::fa("link")`](https://www.unipd-ubep.it/) [**www.unipd-ubep.it**](https://www.unipd-ubep.it/)

[`r fontawesome::fa("mail-bulk")`](mailto:Corrado.Lanera@ubep.unipd.it) [**Corrado.Lanera**__.orange[@ubep.unipd.it]__](mailto:Corrado.Lanera@ubep.unipd.it)

[`r fontawesome::fa("github")`](https://github.com/corradolanera)
[`r fontawesome::fa("twitter")`](https://twitter.com/corradolanera)
[`r fontawesome::fa("telegram-plane")`](https://telegram.me/CorradoLanera)
**@CorradoLanera**

[`r fontawesome::fa("github")`](https://github.com/UBESP-DCTV)
**@UBESP-DCTV**


---
class: hide-count


# .orange[Outline]

- Intro: definition of .orange[ASAP], the anatomy of a **patchwork**

- Program: start .orange[easy], do **not waste time**, look at possible futures

- Day 1:
  - Setup an **R**/**RStudio** project: `{here}`, `{renv}`, and .orange[git].
  - Do they talk you about **folders**?
  - What if **something change**? .orange[DRY]: Do Not Repeat Yourself!
      + Data / **objects** (versions?)
      + Code / Functions (.orange[refactor]?)
      + **Bugs** (tests?)
  - Please, give me some .orange[structure]! The magic of `DESCRIPTION`
  - Oops! I have (internal) .orange[private data] for my (public) project!
  - Are you ready to .orange[share] and collaborate? (welcome **GitHub**)

- Day 2:
  - Welcome `{laims.template}`
  - **Conventions** are all about making stuff .orange[invisible]!
  - working with `{targets}`

- Outro: definition of .orange[ASAP], the anatomy of a **project**


---
class: hide-count

# Code of Conduct

The workshop will be conducted with a .orange[Code of Conduct]. By participating to the workshop, **you agree to abide by its terms**.

Any form of behaviour to .orange[exclude], .orange[intimidate], or .orange[cause discomfort] **is a violation** of the Code of Conduct.

In order to foster a .orange[positive and professional] learning environment I encourage the following kinds of behaviours:

  - Use **welcoming** and **inclusive** language
  - Be **respectful** of different viewpoints and experiences
  - Gracefully **accept** constructive criticism
  - Focus on what is **best for the community**
  - Show **courtesy** and **respect** towards other community members

If you believe someone is violating the Code of Conduct, I ask that you .orange[report it to me] and **I will take the appropriate actions** to address the situation.

> If you believe **I am violating the Code of Conduct**, you can write to the responsible of our administration (<Cristiana.Vettori@ubep.unipd.it>) to report the incident.

.center[**Thank .orange[you]!**]


---

# How to follow the workshops

1. Do it by yourself

2. At any stage you can:
  `usethis::use_course("CorradoLanera/<name>.<stage>")`

3. If you cannot (don't like) to run locally:
  Posit Cloud (free for you) Workspace: [https://bit.ly/positcloud-ws-reproj](https://bit.ly/positcloud-ws-reproj)
 
 
4. Moves the **red** sticky note forward, if I am too fast
5. Moves the .orange[Yellow] sticky note forward, if I am too slow
6. For questions, rise your hands if you are not typing on a laptop, or put a sticky note on the rear of the laptop otherwise.

### Resources

- .orange[Slides]: [https://corradolanera.github.io/ws-reproj/](https://corradolanera.github.io/ws-reproj/#1)
- Posit .orange[Cloud Workspace]: [https://bit.ly/positcloud-ws-reproj](https://bit.ly/positcloud-ws-reproj)
- Whole .orange[project]: [https://github.com/CorradoLanera/ws-reproj](https://github.com/CorradoLanera/ws-reproj)

---
class: inverse, middle, center, hide-count

# .orange[Intro: **ASAP**]
 

---

# .orange[AS]AP

.orange[As Soon] As Possible

- do the analysis

--

- update (overwrite) data

- update (overwrite) the analysis

- add a copy of the script (just to be sure)

--

- fix bug (in second version of analysis)

- add an additional faster version (saving 14ms after 2h of hard-coding)

--

- send preliminary (hopefully super-trusted correct) report

--

- .orange[**BUG** reported by the boss!] (... it's a **BOGSS**)

--

- cannot give up to the shame: new version night-time without sleep
- ASAP ASAP ASAP ASAP
- (new files, new versions, new names, new plots)
- SENT!

---
class: inverse, middle, center, hide-count

...

--

...

---
class: middle, center

.orange[**BOGSS**]

--

finally shamed

project passed to new analyst

... ASAP ASAP ASAP... ASAY (**As Soon As YESTERDAY**)

--

<br>

cannot understand ANYTHING of the work already done! (...what a of newbe!)


RESTART (adding sub-folders, sub-files, sub-version, sub-something to the project!)

<br>

.orange[DONE] before diner!

---
class: inverse, middle, center, hide-count

...

--

...

---
class: middle, center

.orange[**BOGSS**]

--

<br>

BOSS: "I would have spend less time if did it by myself!"

BOSS: Ok, I will do it!

BOSS: ... which are the original/last data?! ...

--

<br>

...


--

<br>
BOSS: ChatGPT, write a report that appear to correctly assess the analyses!

--

.orange[**THE END.**]


---
class: inverse, middle, center, hide-count

Go Tidyverse

---
class: middle, center

<img src="img/tidy-red.png" width="100%"/>

---
class: inverse, middle, center, hide-count

Time pass...

---
class: middle, center

<img src="img/time-red.png" width="100%"/>




---
class: inverse, middle, center, hide-count

# .orange[Don't waste **time**]
 

---

# Which one **time**?!

- Your time?!
- My time?!
- Boss time?!

--

<br>

.center[.orange[Project time] =

$$\sum_{i = 1}^{correct\ version!}\left(\sum_{p\in team}\sum_{t\in tasks} time_i(by = p, for = t, include\_breaks = TRUE)\right)$$
]
--
<br>
<br>

.center[
$$ASAP := argmin(Project\ time)$$
(.orange[CL] **personal** definition!)

]

---
class: inverse, middle, center, hide-count

# .orange[Day **1**]


---

# Create a project

Just a bare project

> create new RStudio project (including git and {renv} ticks)

> `usethis::use_course("CorradoLanera/bare.proj.01")`

> Posit Cloud: 01 - Bare project

--

- lets talk about `{here}` (and a `00-setup.R` script)

--

- lets talk about `{renv}`

--

- lets talk about git

---

# Start some analysis

- analysis.R
- report.rmd


> where to put input data and output files? How to reach them?


---
class: inverse, middle, center, hide-count

.orange[Live session]

Start from:

`usethis::use_course("CorradoLanera/bare.proj.01")`

Posit Cloud: 01 - Bare project


---

# Changes?

> what if some input/output file changed?

> what about repeated code?

> what if you find some bugs?


---
class: inverse, middle, center, hide-count

.orange[Live session]

Start from:

`usethis::use_course("CorradoLanera/foldered.02")`

Posit Cloud: 02 - Foldered


---

# All this code together is really really ORRIBLE and confusing!

> what about some structure?

> what about repeated code?


---
class: inverse, middle, center, hide-count

.orange[Live session]

Start from:

`usethis::use_course("CorradoLanera/changes.dry.03")`

Posit Cloud: 03 - Changes & DRY


---

# Data Protection...

> what if I have private data (centralized, and visible by colleague only)?

> What if I would like to share the code (but not the data)?


---
class: inverse, middle, center, hide-count

.orange[Live session]

Start from:

`usethis::use_course("CorradoLanera/structure.04")`

Posit Cloud: 04 - structure




 
---
class: inverse, middle, center, hide-count

# .orange[Day **2**]

## `laims.tempalte`

---

# Already .orange[explored] features

- (`{here}`)<sup>*</sup> (your .orange[path will works] on everyone computers!)

- git + GitHub (you can .orange[collaborate] and .orange[share] your code, tracking yours and others changes at every single lines levels)

- `{renv}` (packages .orange[updates will not scare] you anymore!)

- `{devtools}` + DESCRIPTION + R/ + tests/ (you know exactly where your functions are, with .orange[provable confidence] of their works, and everything as difficult as pressing `CTRL` + `SHIFT` + `T`)

- (`analysis.R`)<sup>*</sup> + `report.R` (directly inject your - __Updated__ - objects into your reports and sample code)

- private data-raw/, (data/)<sup>*</sup>, and output/ (.orange[everyone can read] your code, only your collaborators and .orange[authorized people can run] it! Still, __you can share__ a selection of derived object to anyone!)


.footnote[[*] Why this is between parentheses it will be clear soon.] 


---
# New .orange[(not yet) explored] features

- powered by `{targets}`:

  + automatic discovering and saving of intermediate/final computed objects

  + automatic discovering of functions and objects dependencies
  
  + automatic run of all and only one outdated dependencies for updates

- an `explore.R` script specifically designed to host completely **unruled** stuff, i.e., ugly, un-styled, un-commented, un-usual, un-working, temporary code (which can be easily deleted time-after-time, maintaining their evidence and lesson-learnt thanks to git!)

- created objects are directly usable on computations, reports, and tests (maintaining their privacy if shared storage selected)

- professional-grade report,including logos, authorships with OrcID, citations, marginal notes, custom size for figures, and more (and maybe even more than more if powered by Quarto<sup>*</sup>)


.footnote[[*] We will not talk about Quarto today, if interested see: [https://quarto.org/](https://quarto.org/), and [https://books.ropensci.org/targets/literate-programming.html#quarto-targets](https://books.ropensci.org/targets/literate-programming.html#quarto-targets).] 

---
# .orange[Bonus-unexplored] feature

- Code testing coverage: _What .orange[percentage] of "**do-something**" lines of code are effectively tested?_

- Lint checks: _How .orange[good] is your code "**statically**"?_

- GitHub Action: _.orange[automatic] execution of tests/lint/CRAN checks at **every push**!_

- R-package structure: _you can make exported functions available as a **ready-to-use** .orange[r-package]._



---
class: inverse, middle, center, hide-count

.orange[Live session]

Take as reference:

`usethis::use_course("CorradoLanera/private.05")`

or

Posit Cloud: 05 - private


and go to [https://github.com/UBESP-DCTV/laims.analysis](https://github.com/UBESP-DCTV/laims.analysis)<br>(You will need a (free) GitHub account!)


---
class: inverse, middle, center, hide-count

# .orange[Outro: **ASAP** and recap]


---

# AS.orange[AP]

As Soon .orange[As Possible]

- Start .orange[easy] and .orange[slow] but keep your eyes on your final results!

- If your results are not correct, all your _high-speed_ goes down to zero!

- **Bugs will arrive**. For sure! (The greatest error you can do is to assume your code will be error-free)

- Do/check .orange[only] what you really have to do/check

- Enforce .orange[standards] and .orange[style]

- Use **templates**

---

# Technical recap

- Track
  + changes (git)
  + environment (`{renv}`)

- Use portable paths (`{here}`)

- Use **standard** folder and files (keep structure .orange[invisible])

- .orange[Refactor] your code to extract logic by level of abstraction

- (**DRY**)

- Use `DESCRIPTION` to activate R/RStudio super-powers (functions, tests, ...)

- Environmental variables (from function calls!) to point to private locations

- Let `{targets}` to manage project dependencies, efficient runs, and efficient storage of your objects.

- Use GitHub (or similar) platform to share code (not data, and not secrets!) with collaborators, journals, public!

.center[**If you need all of above, use templates! (like the `laims.analysis` one)**]

--

.center[Go for $ASAP := argmin(Project\ time)$!!]

---
class: inverse, center, middle, hide-count


.bg-washed-green.b--dark-green.ba.bw2.br3.shadow-5.ph4.mt5[
.left[
_.orange[The best] is the enemy of the good!_ <br> .center[... but ...] <br> .right[_The only way to go fast is to .orange[GO WELL!]_]
]

.tr[
— Voltaire + Uncle Bob
]
]

<br>

# Thank .orange[you] for the attention!


Slides: [https://CorradoLanera.github.io/ws-reproj/](https://CorradoLanera.github.io/ws-reproj/#1)

Repo: [https://github.com/CorradoLanera/ws-reproj](https://github.com/CorradoLanera/ws-reproj)

<br>


[`r fontawesome::fa("link")`](https://www.unipd-ubep.it/) [**www.unipd-ubep.it**](https://www.unipd-ubep.it/) | 
[`r fontawesome::fa("mail-bulk")`](mailto:Corrado.Lanera@ubep.unipd.it) [**Corrado.Lanera@ubep.unipd.it**](mailto:Corrado.Lanera@ubep.unipd.it)

[`r fontawesome::fa("github")`](https://github.com/corradolanera)
[`r fontawesome::fa("twitter")`](https://twitter.com/corradolanera)
[`r fontawesome::fa("telegram-plane")`](https://telegram.me/CorradoLanera)
**@CorradoLanera** | 
[`r fontawesome::fa("github")`](https://github.com/UBESP-DCTV)
**@UBESP-DCTV**


